@extends('layouts.app')

@section('content')
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">Изменить решения уязвимости</div>

                <div class="card-body">
                    <form action="{{ route('report.update_vulnerability', $vulnerability->id) }}" method="POST">
                        @csrf
                        @method('PUT')
                        <div class="form-group">
                            <label for="real_solutions">Реальные решения</label>
                            @if($vulnerability->realSolutions !== null)
                                @foreach($vulnerability->realSolutions as $solution)
                                    <div class="form-group">
                                        <input type="text" class="form-control" name="real_solutions[{{ $solution->id }}]"
                                            value="{{ $solution->solution }}">
                                    </div>
                                @endforeach
                            @endif
                            <button type="button" class="btn btn-secondary" id="addRealSolution">Добавить новое реальное
                                решение</button>
                            <div id="realSolutionsContainer"></div>

                            <label for="compensating_solutions">Компенсируемые решения</label>
                            <div class="form-group">
                                <select id="compensatingSolutionsSelect" class="form-control mb-2">
                                    @foreach($compensating as $solution)
                                        @if(!$vulnerability->compensatingSolutions->contains($solution->id))
                                            <option value="{{ $solution->id }}">{{ $solution->measure }}</option>
                                        @endif
                                    @endforeach
                                </select>
                                <button type="button" class="btn btn-secondary" id="addCompensatingSolution">Добавить
                                    новое компенсирующее решение</button>
                            </div>
                            <div id="selectedCompensatingSolutionsContainer">
                                @if ($vulnerability->compensatingSolutions !== null)
                                    @foreach($vulnerability->compensatingSolutions as $solution)
                                        <div class="selected-solution" data-id="{{ $solution->id }}">
                                            {{ $solution->measure }}
                                            <button type="button" class="btn btn-danger btn-sm remove-solution">Удалить</button>
                                            <input type="hidden" name="compensating_solutions[]" value="{{ $solution->id }}">
                                        </div>
                                    @endforeach
                                @endif
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                            <a href="{{ route('report.all_vulnerabilites', $document->id) }}" class="btn btn-secondary">Отмена</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@section('scripts')
<script>
    document.getElementById('addRealSolution').addEventListener('click', function () {
        var container = document.getElementById('realSolutionsContainer');
        var input = document.createElement('input');
        input.type = 'text';
        input.name = 'new_real_solutions[]';
        input.className = 'form-control mt-2 mb-4';
        input.placeholder = 'Введите новое реальное решение';
        container.appendChild(input);
    });

    document.getElementById('addCompensatingSolution').addEventListener('click', function () {
        var select = document.getElementById('compensatingSolutionsSelect');
        var selectedOption = select.options[select.selectedIndex];
        if (selectedOption.value) {
            var container = document.getElementById('selectedCompensatingSolutionsContainer');
            var div = document.createElement('div');
            div.className = 'selected-solution';
            div.dataset.id = selectedOption.value;
            div.innerHTML = selectedOption.text + ' <button type="button" class="btn btn-danger btn-sm remove-solution">Удалить</button>';
            var hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'compensating_solutions[]';
            hiddenInput.value = selectedOption.value;
            div.appendChild(hiddenInput);
            container.appendChild(div);

            // Remove the selected option from the dropdown
            select.remove(select.selectedIndex);
        }
    });

    document.getElementById('selectedCompensatingSolutionsContainer').addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-solution')) {
            var solutionDiv = event.target.parentElement;
            var solutionId = solutionDiv.dataset.id;
            var select = document.getElementById('compensatingSolutionsSelect');
            var option = document.createElement('option');
            option.value = solutionId;
            option.text = solutionDiv.firstChild.nodeValue.trim();
            select.appendChild(option);
            solutionDiv.remove();
        }
    });
</script>
@endsection